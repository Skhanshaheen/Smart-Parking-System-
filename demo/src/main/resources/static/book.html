<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book Your Spot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #0d1117; color: white; font-family: 'Segoe UI', sans-serif; }
        .main-card { background-color: white; color: #333; border-radius: 15px; padding: 40px; margin-top: 50px; max-width: 600px; }
        .form-control { border-radius: 8px; padding: 12px; }
    </style>
</head>
<body>
<div class="container d-flex justify-content-center">
    <div class="main-card shadow-lg w-100">
        <h2 class="fw-bold mb-2 text-dark text-center">Parking Details</h2>
        <p class="text-center text-muted mb-4">Confirming spot <span class="fw-bold text-primary" id="displayId">...</span></p>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label small text-uppercase fw-bold">Your Full Name</label>
                <input type="text" id="name" class="form-control" placeholder="Enter your name">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label small text-uppercase fw-bold">Vehicle Brand</label>
                <input type="text" id="brand" class="form-control" placeholder="e.g. Tesla">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label small text-uppercase fw-bold">Vehicle Color</label>
                <input type="text" id="color" class="form-control" placeholder="e.g. Silver">
            </div>
            <div class="col-md-12 mb-3">
                <label class="form-label small text-uppercase fw-bold">License Plate (Reg)</label>
                <input type="text" id="reg" class="form-control" placeholder="e.g. ABC 1234">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label small text-uppercase fw-bold">Stay Length (Days)</label>
                <input type="number" id="days" class="form-control" value="1" min="1">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label small text-uppercase fw-bold">Booking Date</label>
                <input type="text" id="dateDisplay" class="form-control bg-light" readonly>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label small text-uppercase fw-bold text-muted">Create 4-Digit Security PIN</label>
            <input type="password" id="pin" class="form-control form-control-lg" 
                id="pin" 
                inputmode="numeric" 
                pattern="\d{4}" 
                maxlength="4" 
                placeholder="Ex: 1234" required>
        
                <div class="form-text">You will need this PIN to cancel your booking later.</div>
        </div>

        <button class="btn btn-primary w-100 fw-bold mt-4 py-3" onclick="processBooking()">COMPLETE RESERVATION</button>
        <div class="text-center mt-3"><a href="index.html" class="text-muted text-decoration-none small">Cancel and go back</a></div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const spaceId = urlParams.get('id');
    const bookingDate = urlParams.get('date'); 

    document.getElementById('displayId').innerText = spaceId;
    document.getElementById('dateDisplay').value = bookingDate;

    async function processBooking() {
        const pinValue = document.getElementById('pin').value;

        if (!pinValue || pinValue.length !== 4) {
            alert("Please enter a 4-digit security PIN.");
            return;
        }

        const payload = {
            vehId: spaceId,
            name: document.getElementById('name').value,
            brand: document.getElementById('brand').value,
            color: document.getElementById('color').value,
            reg: document.getElementById('reg').value,
            startDate: bookingDate,
            days: document.getElementById('days').value,
            pin: String(pinValue)
        };

        if(!payload.name || !payload.brand) return alert("Please fill in your name and car brand.");

        try {
            // FIXED: Pointing to the correct booking API and fixed the syntax
            const res = await fetch('/api/quick-book', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            if(data.ok) {
                alert("Booking Confirmed!");
                location.href = 'index.html';
            } else {
                alert("Error: " + data.message);
            }
        } catch (error) {
            console.error(error);
            alert("Server Error: Check if your Spring Boot app is running.");
        }
    }
</script>
</body>
</html>